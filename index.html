<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Image Lab</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e5e5; }
        .nexus-card { background: #171717; border: 1px solid #262626; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .nexus-input { background: #0a0a0a; border: 1px solid #404040; transition: border-color 0.2s; }
        .nexus-input:focus { border-color: #10b981; outline: none; }
        .nexus-btn { background: #10b981; transition: transform 0.1s, background-color 0.2s; }
        .nexus-btn:hover { background: #059669; }
        .nexus-btn:active { transform: scale(0.98); }
        .image-container { min-height: 512px; border: 2px dashed #262626; }
        .loader { border-top-color: #10b981; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 lg:p-12">

    <div class="w-full max-w-5xl nexus-card rounded-2xl p-8 lg:p-12 grid grid-cols-1 lg:grid-cols-2 gap-12">
        
        <!-- Controls Column -->
        <div class="space-y-6">
            <div class="flex justify-between items-start">
                <div class="space-y-1">
                    <h1 class="text-3xl font-bold tracking-tight text-white font-mono uppercase text-emerald-500">Nexus // Vision</h1>
                    <p class="text-neutral-400 font-mono text-xs tracking-widest">[ MULTI-PARAMETER SYNTHESIS ]</p>
                </div>
                <div class="text-right bg-neutral-900 px-4 py-2 rounded-lg border border-neutral-800">
                    <p class="text-[10px] text-neutral-500 uppercase tracking-widest font-bold">Total Pollen</p>
                    <p id="pollenCount" class="text-xl font-mono text-emerald-400">---</p>
                </div>
            </div>

            <div class="space-y-4">
                <div class="grid grid-cols-3 gap-4 items-end">
                    <div class="col-span-2">
                        <label class="block text-xs font-bold mb-2 text-neutral-500 uppercase tracking-widest">Model Engine (Sorted by Cost)</label>
                        <select id="modelSelect" onchange="updateModelPrice()" class="w-full nexus-input rounded-lg p-3 text-white text-sm">
                            <option value="">Loading Models...</option>
                        </select>
                    </div>
                    <div class="text-right bg-neutral-900 px-4 py-3 rounded-lg border border-neutral-800">
                        <p class="text-[9px] text-neutral-500 uppercase tracking-widest font-bold mb-1">Cost / Gen</p>
                        <p id="modelCost" class="text-sm font-mono text-emerald-500">0.0000</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold mb-2 text-neutral-500 uppercase tracking-widest">Aspect Ratio</label>
                        <select id="aspectRatio" class="w-full nexus-input rounded-lg p-3 text-white text-sm">
                            <option value="1024x1024">Square (1:1)</option>
                            <option value="1280x720">Wide (16:9)</option>
                            <option value="720x1280">Tall (9:16)</option>
                            <option value="1024x768">Classic (4:3)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold mb-2 text-neutral-500 uppercase tracking-widest">Fixed Seed</label>
                        <input id="seedInput" type="number" class="w-full nexus-input rounded-lg p-3 text-white text-sm" placeholder="Random (-1)" value="-1">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold mb-2 text-neutral-500 uppercase tracking-widest">Positive Prompt</label>
                    <textarea id="promptInput" rows="4" class="w-full nexus-input rounded-lg p-3 text-white placeholder-neutral-700 text-sm" placeholder="Describe the vision..."></textarea>
                </div>

                <div>
                    <label class="block text-xs font-bold mb-2 text-neutral-500 uppercase tracking-widest">Negative Prompt (Exclude)</label>
                    <input id="negativeInput" type="text" class="w-full nexus-input rounded-lg p-3 text-white placeholder-neutral-700 text-sm" placeholder="blurry, distorted, text...">
                </div>

                <button onclick="generateImage()" id="genBtn" class="w-full nexus-btn text-white font-bold py-4 rounded-xl shadow-lg flex items-center justify-center space-x-2 uppercase tracking-widest mt-4">
                    <span>Engage Synthesis</span>
                </button>
            </div>
        </div>

        <!-- Result Column -->
        <div id="resultArea" class="image-container rounded-xl overflow-hidden flex items-center justify-center relative bg-black shadow-inner border border-neutral-800">
            <div id="loadingOverlay" class="hidden absolute inset-0 bg-black/80 flex flex-col items-center justify-center space-y-4 z-10">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
                <p class="text-emerald-400 font-mono text-sm animate-pulse uppercase tracking-widest text-center px-4">Modulating Neural Lattice...</p>
            </div>
            <img id="outputImage" class="max-w-full max-h-full object-contain hidden" src="" alt="Generated artwork">
            <div id="placeholderText" class="text-neutral-700 text-center p-8 font-mono text-xs max-w-xs uppercase leading-loose">
                [ Waiting for parameters to be injected into the stream ]
            </div>
        </div>
    </div>

    <script>
        let modelCache = [];

        function formatBalance(val) {
            return Number(val).toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 4 });
        }

        async function fetchMetadata() {
            const select = document.getElementById('modelSelect');
            const pollen = document.getElementById('pollenCount');
            try {
                const bRes = await fetch('https://image.1984.ie/balance');
                const bData = await bRes.json();
                pollen.textContent = formatBalance(bData.balance);
            } catch (err) { pollen.textContent = "ERR"; }

            try {
                const mRes = await fetch('https://image.1984.ie/models');
                modelCache = await mRes.json();
                
                // Sort by cost (ascending)
                modelCache.sort((a, b) => {
                    const priceA = a.pricing ? (a.pricing.completionImageTokens || 0) : 0;
                    const priceB = b.pricing ? (b.pricing.completionImageTokens || 0) : 0;
                    return priceA - priceB;
                });

                select.innerHTML = '';
                modelCache.forEach(model => {
                    const opt = document.createElement('option');
                    opt.value = model.name;
                    // Use description if available, otherwise capitalize name
                    let displayName = model.name.toUpperCase();
                    if (model.description) {
                        // Extract the first part of the description before the dash or use it all
                        displayName = model.description.split(' - ')[0].toUpperCase();
                    }
                    opt.textContent = displayName;
                    if (model.name === 'klein-large') opt.selected = true;
                    select.appendChild(opt);
                });
                updateModelPrice();
            } catch (err) {
                select.innerHTML = '<option value="klein-large">KLEIN-LARGE</option>';
            }
        }

        function updateModelPrice() {
            const select = document.getElementById('modelSelect');
            const priceEl = document.getElementById('modelCost');
            const selected = modelCache.find(m => m.name === select.value);
            if (selected && selected.pricing) {
                const cost = selected.pricing.completionImageTokens || 0;
                priceEl.textContent = Number(cost).toFixed(4);
            } else {
                priceEl.textContent = "0.0000";
            }
        }

        async function updateBalanceOnly() {
            const pollen = document.getElementById('pollenCount');
            try {
                const bRes = await fetch('https://image.1984.ie/balance');
                const bData = await bRes.json();
                pollen.textContent = formatBalance(bData.balance);
            } catch (err) {}
        }

        function generateImage() {
            const model = document.getElementById('modelSelect').value;
            const promptVal = document.getElementById('promptInput').value;
            const negPrompt = document.getElementById('negativeInput').value;
            const ratio = document.getElementById('aspectRatio').value.split('x');
            const seedVal = document.getElementById('seedInput').value;
            
            const img = document.getElementById('outputImage');
            const overlay = document.getElementById('loadingOverlay');
            const placeholder = document.getElementById('placeholderText');
            const btn = document.getElementById('genBtn');

            if (!promptVal) return;

            overlay.classList.remove('hidden');
            img.classList.add('hidden');
            placeholder.classList.add('hidden');
            btn.disabled = true;
            btn.style.opacity = '0.5';

            const prompt = encodeURIComponent(promptVal);
            const negative = encodeURIComponent(negPrompt);
            const width = ratio[0];
            const height = ratio[1];
            const seed = seedVal === "-1" ? Math.floor(Math.random() * 1000000000) : seedVal;

            const url = `https://image.1984.ie/${prompt}?model=${model}&seed=${seed}&width=${width}&height=${height}&negative_prompt=${negative}`;

            const tempImg = new Image();
            tempImg.onload = function() {
                img.src = url;
                img.classList.remove('hidden');
                overlay.classList.add('hidden');
                btn.disabled = false;
                btn.style.opacity = '1';
                setTimeout(updateBalanceOnly, 2000);
            };
            tempImg.onerror = function() {
                alert("Synthesis Failure. Check network parameters.");
                overlay.classList.add('hidden');
                placeholder.classList.remove('hidden');
                btn.disabled = false;
                btn.style.opacity = '1';
            };
            tempImg.src = url;
        }

        fetchMetadata();
    </script>
</body>
</html>
